<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MITS Canteen Dashboard</title>
  <style>
    html, body 
    {
      height: 100%;
    }
    body 
    {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f4f4f4 60%, #e0e7ef 100%);
      overflow-x: hidden;
    }
    main 
    {
      flex: 1;
    }
    header 
    {
      background: #e3eafc;
      color: #1e40af;
      padding: 32px 0 28px 0;
      text-align: center;
      box-shadow: 0 2px 12px rgba(30, 64, 175, 0.13);
      border-radius: 0 0 24px 24px;
      position: relative;
    }

    .brand-logo 
    {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      margin-bottom: 12px;
    }

    .logo 
    {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 2px 12px rgba(17, 246, 154, 0.916);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .logo:hover 
    {
      transform: scale(1.08) rotate(-3deg);
      box-shadow: 0 6px 24px rgba(117, 180, 184, 0.879);
    }

    .brand-text 
    {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .brand-title 
    {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .brand-mits 
    {
      color: #1eaf6e; 
    }

    .brand-canteen 
    {
      color: #ff9800; 
      font-weight: 900;
    }

    .brand-subtitle 
    {
      font-size: 1rem;
      color: #4a6572;
      font-weight: 500;
      margin-top: 2px;
      letter-spacing: 0.5px;
    }

    header::after 
    {
      content: "";
      display: block;
      width: 80%;
      height: 3px;
      background: linear-gradient(90deg, #ffd166 0%, #fcb900 100%);
      border-radius: 2px;
      margin: 28px auto 0 auto;
      opacity: 0.7;
    }
    .navbar 
    {
      display: flex;
      justify-content: center;
      gap: 25px;
      background: #f8fcfe;
      padding: 28px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .nav-item 
    {
      background: #f7fafc;
      padding: 22px 25px;
      border-radius: 18px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      width: 160px;
      box-shadow: 0 4px 18px rgba(53, 66, 74, 0.12);
    }

    .nav-item:hover 
    {
      transform: translateY(-8px) scale(1.07);
      box-shadow: 0 8px 32px rgba(53, 66, 74, 0.18);
      background: #fffbe6;
    }

    .nav-item img 
    {
      width: 100px;
      height: 100px;
      margin-bottom: 8px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(53, 66, 74, 0.08);
      background: #fff;
      transition: 0.3s;
    }

    .nav-item:hover img 
    {
      transform: scale(1.1);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }

    .nav-text 
    {
      font-size: 1.1rem;
      font-weight: 600;
      color: #35424a;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px #e0e7ef;
      text-align: center;
      line-height: 1.2;
      margin-top: 4px;
    }

    .content-container 
    {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 30px;
    }

    .content 
    {
      background: rgb(245, 243, 243);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 1200px;
      display: none;
      overflow-x: auto;
    }

    .table-container {
      overflow-x: auto;
      margin: 0 -10px;
      padding: 0 10px;
    }

    @media (max-width: 1024px) {
      .content {
        max-width: 95%;
        padding: 15px;
      }
      
      table {
        font-size: 0.8rem;
      }
      
      th, td {
        padding: 6px 8px;
      }
    }

    @media (max-width: 768px) {
      .content {
        padding: 10px;
      }
      
      table {
        font-size: 0.75rem;
      }
      
      th, td {
        padding: 4px 6px;
      }
      
      th:nth-child(5), td:nth-child(5),
      th:nth-child(8), td:nth-child(8) {
        display: none;
      }
    }

    table 
    {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      font-size: 0.9rem;
    }

    table, th, td 
    {
      border: 1px solid #e2e4eb;
    }

    th, td 
    {
      padding: 8px 10px;
      text-align: center;
      vertical-align: middle;
    }

    th 
    {
      background: #e4eaf0;
      color: #2647ce;
      font-weight: 600;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    td 
    {
      font-size: 0.85rem;
      line-height: 1.4;
    }

    tr:nth-child(even) 
    {
      background: #f9f9f9;
    }

    tr:hover 
    {
      background: #f0f7ff;
    }

    /* Specific column widths */
    th:nth-child(1), td:nth-child(1) { width: 15%; } /* User */
    th:nth-child(2), td:nth-child(2) { width: 10%; } /* Register No */
    th:nth-child(3), td:nth-child(3) { width: 8%; }  /* Type */
    th:nth-child(4), td:nth-child(4) { width: 20%; } /* Items */
    th:nth-child(5), td:nth-child(5) { width: 15%; } /* Delivery */
    th:nth-child(6), td:nth-child(6) { width: 8%; }  /* Total */
    th:nth-child(7), td:nth-child(7) { width: 8%; }  /* Status */
    th:nth-child(8), td:nth-child(8) { width: 12%; } /* Time */
    th:nth-child(9), td:nth-child(9) { width: 12%; } /* Action */

    /* User column styling */
    td:nth-child(1) {
      text-align: left;
      font-weight: 500;
    }

    td:nth-child(1) small {
      color: #666;
      font-size: 0.75rem;
      display: block;
      margin-top: 2px;
    }

    /* Register number styling */
    td:nth-child(2) {
      font-weight: 600;
      color: #1e40af;
    }

    /* Items column styling */
    td:nth-child(4) {
      text-align: left;
      font-size: 0.8rem;
      max-width: 200px;
      word-wrap: break-word;
    }

    /* Delivery column styling */
    td:nth-child(5) {
      text-align: left;
      font-size: 0.75rem;
    }

    /* Status column styling */
    td:nth-child(7) {
      font-weight: 500;
      text-transform: capitalize;
    }

    /* Time column styling */
    td:nth-child(8) {
      font-size: 0.75rem;
      color: #666;
    }

    /* Action column styling */
    td:nth-child(9) select {
      font-size: 0.75rem;
      padding: 4px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }

    .remove-btn {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
      margin-top: 4px;
    }

    .remove-btn:hover {
      background: #fecaca;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      background: #1e40af;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .pagination button:hover {
      background: #1d4ed8;
    }

    .pagination button:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }

    .pagination .page-info {
      color: #1e40af;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .search-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }

    .search-container input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      width: 200px;
    }

    .search-container select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      background: white;
      width: 120px;
    }

    .search-container input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      width: 150px;
    }

    .search-container button {
      background: #1e40af;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .search-container button:hover {
      background: #1d4ed8;
    }

    .table-title 
    {
      margin: 15px 0;
      font-size: 1.3rem;
      font-weight: bold;
      color: #1e40af;
      text-align: left;
    }

    footer 
    {
      text-align: center;
      padding: 22px 0;
      background: linear-gradient(90deg, #35424a 60%, #4a6572 100%);
      color: #ffffff;
      width: 100%;
      font-size: 1rem;
      letter-spacing: 1px;
      box-shadow: 0 -2px 8px rgba(53, 66, 74, 0.05);
    }

    .food-list 
    {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .food-card 
    {
      background: #f7fafc;
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      width: 140px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: 0.3s;
    }

    .food-card:hover 
    {
      background: #fffbe6;
      transform: scale(1.05);
    }

    .food-card img 
    {
      width: 100px;
      height: 100px;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .stats-container {
      display: flex;
      justify-content: space-around;
      gap: 30px;
      margin: 20px 30px;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc 0%, #e3f2fd 100%);
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.08);
      flex-wrap: wrap;
    }

    .stat-card {
      background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%);
      padding: 18px 12px;
      border-radius: 12px;
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.8);
      transition: all 0.3s ease;
      min-width: 180px;
      flex: 0 0 auto;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #1e40af, #3b82f6, #22c55e, #f59e0b, #ef4444);
    }

    .stat-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 40px rgba(0,0,0,0.18);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #06b6d4 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 6px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      letter-spacing: -0.5px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #475569;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-top: 2px;
    }

    .detailed-stats {
      display: flex;
      gap: 120px;
      margin: 15px 30px;
      justify-content: center;
      flex-wrap: wrap;
      align-items: center;
    }

    .stats-image {
      width: 280px;
      height: 280px;
      border-radius: 12px;
      object-fit: cover;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      animation: pulse 3s ease-in-out infinite;
    }

    .stats-section {
      background: linear-gradient(135deg, #f8fafc 0%, #e3f2fd 100%);
      padding: 18px;
      border-radius: 16px;
      min-width: 240px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      border: 1px solid rgba(30, 64, 175, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }

    .chef-animation {
      position: absolute;
      left: -60px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 3rem;
      animation: cookingAnimation 3s ease-in-out infinite;
    }

    .order-animation {
      position: absolute;
      right: -60px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 3rem;
      animation: orderAnimation 2.5s ease-in-out infinite;
    }

    .floating-emoji {
      position: absolute;
      font-size: 1.5rem;
      animation: floatEmoji 4s ease-in-out infinite;
    }

    .emoji-1 { left: -45px; top: 20%; animation-delay: 0s; }
    .emoji-2 { left: -30px; top: 80%; animation-delay: 1s; }
    .emoji-3 { right: -45px; top: 20%; animation-delay: 0.5s; }
    .emoji-4 { right: -30px; top: 80%; animation-delay: 1.5s; }
    .emoji-5 { left: -75px; top: 30%; animation-delay: 2s; }
    .emoji-6 { right: -75px; top: 70%; animation-delay: 2.5s; }

    @keyframes floatEmoji {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
      50% { transform: translateY(-15px) rotate(10deg); opacity: 1; }
    }

    @keyframes orderAnimation {
      0%, 100% { transform: translateY(-50%) scale(1); }
      25% { transform: translateY(-60%) scale(1.1); }
      50% { transform: translateY(-40%) scale(0.9); }
      75% { transform: translateY(-55%) scale(1.05); }
    }

    @keyframes cookingAnimation {
      0%, 100% { transform: translateY(-50%) rotate(0deg); }
      25% { transform: translateY(-60%) rotate(-10deg); }
      50% { transform: translateY(-40%) rotate(10deg); }
      75% { transform: translateY(-55%) rotate(-5deg); }
    }

    .stats-section:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .stats-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #1e40af;
      margin-bottom: 18px;
      text-align: center;
      padding-bottom: 8px;
      border-bottom: 2px solid rgba(30, 64, 175, 0.2);
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .stats-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 0.9rem;
      padding: 8px 12px;
      background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%);
      border-radius: 8px;
      border-left: 3px solid #1e40af;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .stats-item:hover {
      background: linear-gradient(145deg, #f8fafc 0%, #e3f2fd 100%);
      transform: translateX(5px);
      border-left-color: #22c55e;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stats-item-name {
      color: #374151;
    }

    .stats-item-count {
      font-weight: 700;
      color: #1e40af;
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1rem;
    }

    .alert-section {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 15px;
      margin: 20px;
      display: none;
    }

    .alert-title {
      color: #dc2626;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .alert-item {
      color: #991b1b;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .feature-tabs {
      display: flex;
      gap: 10px;
      margin: 20px;
      justify-content: center;
    }

    .tab-btn {
      background: #e5e7eb;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .tab-btn.active {
      background: #1e40af;
      color: white;
    }

    .feature-content {
      display: none;
      margin: 20px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-on-load {
      animation: fadeInUp 0.8s ease-out;
    }

    .animate-delayed {
      animation: slideInLeft 0.6s ease-out 0.3s both;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .logo {
      animation: float 3s ease-in-out infinite, pulse 2s ease-in-out infinite;
    }

    .brand-title {
      animation: slideIn 1s ease-out 0.2s both;
    }

    .brand-subtitle {
      animation: slideIn 1s ease-out 0.4s both;
    }

    .stat-card {
      animation: pulse 4s ease-in-out infinite;
    }

    .nav-item:hover {
      animation: pulse 0.6s ease-in-out;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes slideInStagger {
      from { opacity: 0; transform: translateY(50px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes moveLeftRight {
      0% { transform: translateX(-700px) scaleX(1); }
      25% { transform: translateX(700px) scaleX(1); }
      50% { transform: translateX(700px) scaleX(-1); }
      75% { transform: translateX(-700px) scaleX(-1); }
      100% { transform: translateX(-700px) scaleX(1); }
    }

    .nav-item:nth-child(1) { animation: bounceIn 0.6s ease-out 0.1s both; }
    .nav-item:nth-child(2) { animation: bounceIn 0.6s ease-out 0.2s both; }
    .nav-item:nth-child(3) { animation: bounceIn 0.6s ease-out 0.3s both; }
    .nav-item:nth-child(4) { animation: bounceIn 0.6s ease-out 0.4s both; }
    .nav-item:nth-child(5) { animation: bounceIn 0.6s ease-out 0.5s both; }

    .stat-card:nth-child(1) { animation: slideInStagger 0.8s ease-out 0.6s both; }
    .stat-card:nth-child(2) { animation: slideInStagger 0.8s ease-out 0.7s both; }
    .stat-card:nth-child(3) { animation: slideInStagger 0.8s ease-out 0.8s both; }
    .stat-card:nth-child(4) { animation: slideInStagger 0.8s ease-out 0.9s both; }
    .stat-card:nth-child(5) { animation: slideInStagger 0.8s ease-out 1.0s both; }
  </style>
</head>
<body>

  <header class="animate-on-load">
    <!-- Canteen name display -->
    <div style="position:absolute; top:16px; right:28px; font-size:1rem; font-weight:600; color:#35424a; background:#ffd166; padding:6px 14px; border-radius:20px; box-shadow:0 2px 6px rgba(53,66,74,0.15);" id="canteen-name-display">Canteen</div>
    
    <div class="brand-logo">
      <img src="mitslogo.png" alt="MITS Logo" class="logo">
      <div class="brand-text">
        <span class="brand-title">
          <span class="brand-mits">MITS</span> 
          <span class="brand-canteen">Canteen</span>
        </span>
        <span class="brand-subtitle">Fresh ‚Ä¢ Tasty ‚Ä¢ Affordable</span>
      </div>
    </div>
  </header>

  <!-- GIF Section -->
  <div style="text-align: center; padding: 15px 0; background: linear-gradient(135deg, #ebebeb 0%, #e3f2fd 100%); border-bottom: 1px solid rgba(30, 64, 175, 0.1);">
    <div style="font-size: 2rem; animation: moveLeftRight 40s infinite;"><img src="images/gif/hel.webp" alt="Menu" style="width: 150px; height: auto;"></div>
  </div>

  <!-- Statistics Dashboard -->
  <div class="stats-container" id="statsContainer" style="display:none;">
    <div class="stat-card">
      <div class="stat-number" id="totalStudents">0</div>
      <div class="stat-label">Students</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalStaff">0</div>
      <div class="stat-label">Staff</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="dailyOrders">0</div>
      <div class="stat-label">Today's Orders</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="dailyRevenue">‚Çπ0</div>
      <div class="stat-label">Today's Revenue</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="monthlyRevenue">‚Çπ0</div>
      <div class="stat-label">Monthly Revenue</div>
    </div>
  </div>

  <!-- Navbar with Images -->
  <div class="navbar animate-delayed">
    <div class="nav-item" onclick="showContent('orders')">
      <img src="images/index/orders.jpg" alt="Orders">
      <div class="nav-text">Orders</div>
    </div>

    <div class="nav-item" onclick="showContent('add')">
      <img src="images/index/add.jpg" alt="Add Item">
      <div class="nav-text">Add Item</div>
    </div>

    <div class="nav-item" onclick="showContent('edit')">
      <img src="images/index/remove.jpg" alt="Edit Item">
      <div class="nav-text">Edit Item</div>
    </div>

    <div class="nav-item" onclick="showContent('profile')">
      <img src="images/index/profile.jpg" alt="Profile">
      <div class="nav-text">Profile</div>
    </div>

    <div class="nav-item" onclick="logout()">
      <img src="images/index/logout.jpg" alt="Logout">
      <div class="nav-text">Logout</div>
    </div>
  </div>

  <!-- Detailed Statistics -->
  <div class="detailed-stats" id="detailedStats" style="display:none;">
    <img src="images/gif/gif2.gif" alt="Menu" class="stats-image">
    <div class="stats-section">
      <div class="stats-title">Menu Items Sold( All Status)</div>
      <div id="menuStats"></div>
    </div>
    <div class="stats-section">
      <div class="stats-title">Order Status</div>
      <div id="orderStatusStats"></div>
    </div>
    <img src="images/gif/gif 3.gif" alt="Menu" class="stats-image">
  </div>

  <!-- Low Stock Alerts -->
  <div class="alert-section" id="lowStockAlerts">
    <div class="alert-title">‚ö†Ô∏è Low Stock Alerts</div>
    <div id="lowStockItems"></div>
  </div>



  <!-- Content -->
  <div class="content-container">
    <div id="content" class="content"></div>
  </div>

  <footer>
    ¬© 2025 MITS Canteen. All Rights Reserved.
  </footer>

  <script src="/socket.io/socket.io.js"></script>
  <script src="js/api.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="js/realtime.js"></script>
  <script>
    // Load canteen name and profile image on page load
    document.addEventListener('DOMContentLoaded', function() {
      if (localStorage.getItem('canteenLoggedIn')) {
        const canteen = JSON.parse(localStorage.getItem('canteen'));
        document.getElementById('canteen-name-display').textContent = canteen.name || 'Canteen';
        
        // Update navbar profile image if available
        const profileNavImg = document.querySelector('.nav-item:nth-child(4) img');
        if (profileNavImg && canteen.canteenPhoto) {
          profileNavImg.src = canteen.canteenPhoto;
        }
        
        loadDashboardStats();
      } else {
        window.location.href = 'canteen-login.html';
      }
    });

    async function loadDashboardStats() {
      document.getElementById('statsContainer').style.display = 'flex';
      document.getElementById('detailedStats').style.display = 'flex';
      try {
        // Get all users directly
        const usersResponse = await fetch('/api/auth/users', {
          headers: { 'Authorization': `Bearer ${API.getToken()}` }
        });
        
        let students = 0, staff = 0;
        if (usersResponse.ok) {
          const users = await usersResponse.json();
          students = users.filter(user => user.role === 'Student').length;
          staff = users.filter(user => user.role === 'Staff').length;
        }
        
        const orders = await API.getAllOrders();
        
        const today = new Date().toDateString();
        const todayOrders = orders.filter(o => new Date(o.createdAt).toDateString() === today);
        const dailyRevenue = todayOrders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + o.totalAmount, 0);
        
        const thisMonth = new Date().getMonth();
        const thisYear = new Date().getFullYear();
        const monthlyOrders = orders.filter(o => {
          const orderDate = new Date(o.createdAt);
          return orderDate.getMonth() === thisMonth && orderDate.getFullYear() === thisYear;
        });
        const monthlyRevenue = monthlyOrders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + o.totalAmount, 0);
        
        document.getElementById('totalStudents').textContent = students;
        document.getElementById('totalStaff').textContent = staff;
        document.getElementById('dailyOrders').textContent = todayOrders.length;
        document.getElementById('dailyRevenue').textContent = `‚Çπ${dailyRevenue}`;
        document.getElementById('monthlyRevenue').textContent = `‚Çπ${monthlyRevenue}`;
        
        // Menu items sold stats with analytics
        const menuStats = {};
        const categoryStats = {};
        let totalRevenue = 0;
        
        orders.forEach(order => {
          order.items.forEach(item => {
            const name = item.menuItem.name;
            const category = item.menuItem.category || 'other';
            const revenue = item.price * item.quantity;
            
            if (!menuStats[name]) {
              menuStats[name] = { quantity: 0, revenue: 0, category: category };
            }
            menuStats[name].quantity += item.quantity;
            menuStats[name].revenue += revenue;
            
            categoryStats[category] = (categoryStats[category] || 0) + item.quantity;
            totalRevenue += revenue;
          });
        });
        
        const topItems = Object.entries(menuStats)
          .sort((a, b) => b[1].quantity - a[1].quantity)
          .slice(0, 6);
        
        const menuStatsHtml = `
          <div class="chef-animation">üë®‚Äçüç≥</div>
          <div class="floating-emoji emoji-1">üç¥</div>
          <div class="floating-emoji emoji-2">üçù</div>
          <div class="floating-emoji emoji-5">üç≥</div>
          <div style="margin-bottom: 15px; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 3px solid #22c55e;">
            <strong> Revenue generated: ‚Çπ${totalRevenue}</strong>
          </div>
          ${topItems.map(([name, data]) => {
            const percentage = ((data.quantity / Object.values(menuStats).reduce((sum, item) => sum + item.quantity, 0)) * 100).toFixed(1);
            return `
              <div class="stats-item" style="flex-direction: column; align-items: flex-start;">
                <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 4px;">
                  <span class="stats-item-name">${name}</span>
                  <span class="stats-item-count">${data.quantity}</span>
                </div>
                <div style="display: flex; justify-content: space-between; width: 100%; font-size: 0.8rem; color: #666;">
                  <span>${data.category.toUpperCase()}</span>
                  <span>‚Çπ${data.revenue} (${percentage}%)</span>
                </div>
                <div style="width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 4px;">
                  <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #1e40af, #3b82f6); border-radius: 2px;"></div>
                </div>
              </div>
            `;
          }).join('')}
        `;
        
        document.getElementById('menuStats').innerHTML = menuStatsHtml;
        
        // Order status stats
        const statusStats = {};
        orders.forEach(order => {
          statusStats[order.status] = (statusStats[order.status] || 0) + 1;
        });
        
        const statusOrder = ['pending', 'confirmed', 'preparing', 'ready', 'delivered', 'cancelled'];
        const statusStatsHtml = `
          <div class="order-animation">üìã</div>
          <div class="floating-emoji emoji-3">üì¶</div>
          <div class="floating-emoji emoji-4">‚úÖ</div>
          <div class="floating-emoji emoji-6">üöö</div>
          ${statusOrder
            .filter(status => statusStats[status])
            .map(status => `
              <div class="stats-item">
                <span class="stats-item-name">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                <span class="stats-item-count">${statusStats[status]}</span>
              </div>
            `).join('')}
        `;
        
        document.getElementById('orderStatusStats').innerHTML = statusStatsHtml;
        
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    async function loadLowStockAlerts() {
      try {
        const categories = ['snacks', 'veg', 'nonveg', 'icecream', 'juice', 'starters'];
        let hasLowStock = false;
        let alertsHtml = '';
        
        for (const category of categories) {
          const menuItems = await API.getMenuItems(category);
          const lowStockItems = menuItems.filter(item => (item.stock || 0) < 10);
          
          if (lowStockItems.length > 0) {
            hasLowStock = true;
            alertsHtml += `<div style="margin-bottom: 10px;"><strong>${category.toUpperCase()}:</strong></div>`;
            alertsHtml += lowStockItems
              .map(item => `<div class="alert-item" style="margin-left: 15px;">${item.name}: ${item.stock || 0} remaining</div>`)
              .join('');
          }
        }
        
        if (hasLowStock) {
          document.getElementById('lowStockAlerts').style.display = 'block';
          document.getElementById('lowStockItems').innerHTML = alertsHtml;
        }
      } catch (error) {
        console.error('Failed to load stock alerts:', error);
      }
    }




    function showContent(tab) {
      const content = document.getElementById("content");
      content.style.display = "block";

      // Show/hide sections based on tab
      if (tab === 'orders') {
        document.getElementById('statsContainer').style.display = 'none';
        document.getElementById('detailedStats').style.display = 'none';
        document.getElementById('lowStockAlerts').style.display = 'none';
      } else {
        document.getElementById('statsContainer').style.display = 'none';
        document.getElementById('detailedStats').style.display = 'none';
        document.getElementById('lowStockAlerts').style.display = 'none';
      }

      switch(tab) {
        case "orders":
          loadOrders();
          break;

        case "add":
          content.innerHTML = `
            <h2 style="color:#1e40af;">Add Food Items</h2>
            <div class="food-list">
              <div class="food-card" onclick="showAddForm('snacks')"><img src="images/index/snacks.png"><span style="font-size:0.9rem; text-align:center; display:block;">Snacks</span></div>
              <div class="food-card" onclick="showAddForm('veg')"><img src="images/index/veg.jpg"><span style="font-size:0.9rem; text-align:center; display:block;">Veg</span></div>
              <div class="food-card" onclick="showAddForm('icecream')"><img src="images/index/ice.webp"><span style="font-size:0.9rem; text-align:center; display:block;">Ice Creams</span></div>
              <div class="food-card" onclick="showAddForm('juice')"><img src="images/index/juice.jpg"><span style="font-size:0.9rem; text-align:center; display:block;">Juice</span></div>
              <div class="food-card" onclick="showAddForm('nonveg')"><img src="images/index/nonveg.jpg"><span style="font-size:0.9rem; text-align:center; display:block;">Non Veg</span></div>
              <div class="food-card" onclick="showAddForm('starters')"><img src="images/index/starters.jpeg"><span style="font-size:0.9rem; text-align:center; display:block;">Starters</span></div>
            </div>
            <div id="addFormContainer" style="margin-top:30px;"></div>
          `;
          break;

        case "edit":
          loadEditFoodItems();
          break;

        // case "profile":
        //   content.innerHTML = "<h2>Profile</h2><p>Profile details go here.</p>";
        //   break;
                case "profile":
          showProfile();
          break;

      }
    }

    let currentPage = 1;
    const ordersPerPage = 10;
    let allOrders = [];
    let filteredOrders = [];
    let currentSearchTerm = '';
    let currentTypeFilter = '';
    let currentActionFilter = '';
    let currentDateFilter = '';

    async function loadOrders() {
      const content = document.getElementById("content");
      content.style.display = "block";
      
      try {
        allOrders = await API.getAllOrders();
        filteredOrders = allOrders;
        
        displayOrdersPage(currentPage);
      } catch (error) {
        content.innerHTML = '<h2>Failed to load orders</h2>';
      }
    }

    function displayOrdersInContainer() {
      const ordersContainer = document.getElementById("ordersContainer");
      const startIndex = (currentPage - 1) * ordersPerPage;
      const endIndex = startIndex + ordersPerPage;
      const ordersToShow = filteredOrders.slice(startIndex, endIndex);
      const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
      
      ordersContainer.innerHTML = `
        <h3 style="color:#1e40af;">User Orders (${filteredOrders.length} total)</h3>
        <div class="search-container">
          <input type="text" id="registerSearch" placeholder="Search by register number..." value="${currentSearchTerm}" onkeypress="if(event.key==='Enter') searchOrders()">
          <select id="typeFilter" onchange="searchOrders()">
            <option value="" ${currentTypeFilter === '' ? 'selected' : ''}>All Types</option>
            <option value="Student" ${currentTypeFilter === 'Student' ? 'selected' : ''}>Student</option>
            <option value="Staff" ${currentTypeFilter === 'Staff' ? 'selected' : ''}>Staff</option>
          </select>
          <input type="date" id="dateFilter" value="${currentDateFilter}" onchange="searchOrders()">
          <button onclick="searchOrders()">Search</button>
          <button onclick="clearSearch()">Clear</button>
        </div>
        <div class="table-container">
        <table>
          <tr>
            <th>User</th>
            <th>Register No.</th>
            <th>Type</th>
            <th>Items</th>
            <th>Delivery</th>
            <th>Total</th>
            <th>Status</th>
            <th>Time</th>
            <th>Action</th>
          </tr>
          ${ordersToShow.map(order => `
            <tr ${order.status === 'cancelled' ? 'style="background-color: #fee2e2; opacity: 0.7;"' : ''}>
              <td>${order.user.name}<br><small>${order.user.email}</small></td>
              <td><strong>${order.user && order.user.role === 'Student' ? (order.user.studentId || 'N/A') : order.user && order.user.role === 'Staff' ? (order.user.staffId || 'N/A') : 'N/A'}</strong></td>
              <td><span style="background: ${order.user && order.user.role === 'Student' ? '#e3f2fd' : '#f3e5f5'}; color: ${order.user && order.user.role === 'Student' ? '#1565c0' : '#7b1fa2'}; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${order.user && order.user.role ? order.user.role : 'Unknown'}</span></td>
              <td>${order.items.map(item => `${item.menuItem.name} (${item.quantity})`).join(', ')}</td>
              <td>
                <small>
                  Room: ${order.deliveryAddress || 'N/A'}<br>
                  Time: ${order.deliveryTime || 'N/A'}<br>
                  Payment: ${order.paymentMethod || 'N/A'}
                </small>
              </td>
              <td>‚Çπ${order.totalAmount}</td>
              <td>${order.status}</td>
              <td>${new Date(order.createdAt).toLocaleString()}</td>
              <td>
                ${order.status === 'cancelled' ? 'No Action' : `
                  <select onchange="updateOrderStatus('${order._id}', this.value)">
                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                    <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                    <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                  </select>
                  ${order.status === 'delivered' ? `<button class='remove-btn' onclick="removeOrder('${order._id}')">Remove</button>` : ''}
                `}
              </td>
            </tr>
          `).join('')}
        </table>
        </div>
        <div class="pagination">
          <button onclick="changeOrderPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê Previous</button>
          <span class="page-info">Page ${currentPage} of ${totalPages}</span>
          <button onclick="changeOrderPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>
        </div>
      `;
    }

    function changeOrderPage(newPage) {
      const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        displayOrdersInContainer();
      }
    }

    function displayOrdersPage(page) {
      const content = document.getElementById("content");
      const startIndex = (page - 1) * ordersPerPage;
      const endIndex = startIndex + ordersPerPage;
      const ordersToShow = filteredOrders.slice(startIndex, endIndex);
      const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
      
      content.innerHTML = `
        <h2 style="color:#1e40af;">User Orders (${filteredOrders.length} total)</h2>
        <div class="search-container">
          <input type="text" id="registerSearch" placeholder="Search by register number..." value="${currentSearchTerm}" onkeypress="if(event.key==='Enter') searchOrders()">
          <select id="typeFilter" onchange="searchOrders()">
            <option value="" ${currentTypeFilter === '' ? 'selected' : ''}>All Types</option>
            <option value="Student" ${currentTypeFilter === 'Student' ? 'selected' : ''}>Student</option>
            <option value="Staff" ${currentTypeFilter === 'Staff' ? 'selected' : ''}>Staff</option>
          </select>
          <select id="actionFilter" onchange="searchOrders()">
            <option value="" ${currentActionFilter === '' ? 'selected' : ''}>All Actions</option>
            <option value="pending" ${currentActionFilter === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="confirmed" ${currentActionFilter === 'confirmed' ? 'selected' : ''}>Confirmed</option>
            <option value="preparing" ${currentActionFilter === 'preparing' ? 'selected' : ''}>Preparing</option>
            <option value="ready" ${currentActionFilter === 'ready' ? 'selected' : ''}>Ready</option>
            <option value="delivered" ${currentActionFilter === 'delivered' ? 'selected' : ''}>Delivered</option>
            <option value="cancelled" ${currentActionFilter === 'cancelled' ? 'selected' : ''}>Cancelled</option>
          </select>
          <input type="date" id="dateFilter" value="${currentDateFilter}" onchange="searchOrders()">
          <button onclick="searchOrders()">Search</button>
          <button onclick="clearSearch()">Clear</button>
        </div>
        <div class="table-container">
        <table>
          <tr>
            <th>User</th>
            <th>Register No.</th>
            <th>Type</th>
            <th>Items</th>
            <th>Delivery</th>
            <th>Total</th>
            <th>Status</th>
            <th>Time</th>
            <th>Action</th>
          </tr>
          ${ordersToShow.map(order => `
            <tr ${order.status === 'cancelled' ? 'style="background-color: #fee2e2; opacity: 0.7;"' : ''}>
              <td>${order.user.name}<br><small>${order.user.email}</small></td>
              <td><strong>${order.user && order.user.role === 'Student' ? (order.user.studentId || 'N/A') : order.user && order.user.role === 'Staff' ? (order.user.staffId || 'N/A') : 'N/A'}</strong></td>
              <td><span style="background: ${order.user && order.user.role === 'Student' ? '#e3f2fd' : '#f3e5f5'}; color: ${order.user && order.user.role === 'Student' ? '#1565c0' : '#7b1fa2'}; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">${order.user && order.user.role ? order.user.role : 'Unknown'}</span></td>
              <td>${order.items.map(item => `${item.menuItem.name} (${item.quantity})`).join(', ')}</td>
              <td>
                <small>
                  Room: ${order.deliveryAddress || 'N/A'}<br>
                  Time: ${order.deliveryTime || 'N/A'}<br>
                  Payment: ${order.paymentMethod || 'N/A'}
                </small>
              </td>
              <td>‚Çπ${order.totalAmount}</td>
              <td>${order.status}</td>
              <td>${new Date(order.createdAt).toLocaleString()}</td>
              <td>
                ${order.status === 'cancelled' ? 'No Action' : `
                  <select onchange="updateOrderStatus('${order._id}', this.value)">
                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                    <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                    <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                  </select>
                  ${order.status === 'delivered' ? `<button class='remove-btn' onclick="removeOrder('${order._id}')">Remove</button>` : ''}
                `}
              </td>
            </tr>
          `).join('')}
        </table>
        </div>
        <div class="pagination">
          <button onclick="changePage(${page - 1})" ${page === 1 ? 'disabled' : ''}>‚Üê Previous</button>
          <span class="page-info">Page ${page} of ${totalPages}</span>
          <button onclick="changePage(${page + 1})" ${page === totalPages ? 'disabled' : ''}>Next ‚Üí</button>
        </div>
      `;
    }

    function changePage(newPage) {
      const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        displayOrdersPage(currentPage);
      }
    }

    function searchOrders() {
      currentSearchTerm = document.getElementById('registerSearch').value.trim().toLowerCase();
      currentTypeFilter = document.getElementById('typeFilter').value;
      currentActionFilter = document.getElementById('actionFilter').value;
      currentDateFilter = document.getElementById('dateFilter').value;
      
      filteredOrders = allOrders.filter(order => {
        const registerId = order.user && order.user.role === 'Student' 
          ? (order.user.studentId || '').toLowerCase()
          : (order.user.staffId || '').toLowerCase();
        
        const matchesSearch = currentSearchTerm === '' || registerId.includes(currentSearchTerm);
        const matchesType = currentTypeFilter === '' || (order.user && order.user.role === currentTypeFilter);
        const matchesAction = currentActionFilter === '' || order.status === currentActionFilter;
        const matchesDate = currentDateFilter === '' || new Date(order.createdAt).toDateString() === new Date(currentDateFilter).toDateString();
        
        return matchesSearch && matchesType && matchesAction && matchesDate;
      });
      
      currentPage = 1;
      displayOrdersPage(currentPage);
    }

    function clearSearch() {
      currentSearchTerm = '';
      currentTypeFilter = '';
      currentActionFilter = '';
      currentDateFilter = '';
      filteredOrders = allOrders;
      currentPage = 1;
      displayOrdersPage(currentPage);
    }

    async function updateOrderStatus(orderId, status) {
      try {
        await API.updateOrderStatus(orderId, status);
        loadOrders();
      } catch (error) {
        alert('Failed to update order status');
      }
    }

    async function removeOrder(orderId) {
      if (confirm('Remove this order from the table?')) {
        try {
          await API.cancelOrder(orderId);
          loadOrders();
        } catch (error) {
          if (error.message && error.message.includes('Not authorized')) {
            alert('You are not authorized to remove this order.');
          } else if (error.message && error.message.includes('order not delivered')) {
            alert('Only delivered orders can be removed.');
          } else {
            alert('Failed to remove order: ' + error.message);
          }
        }
      }
    }
    window.removeOrder = removeOrder;

    // Show Add Item Form
    function showAddForm(category) {
      const formContainer = document.getElementById("addFormContainer");
      formContainer.innerHTML = `
        <h3 style="color:#1e40af;">Add ${category} Item</h3>
        <form onsubmit="addMenuItem(event, '${category}')" style="margin-top:15px; text-align:left;">
          <label><b>Food Name:</b></label><br>
          <input type="text" id="item-name" required style="width:100%; padding:8px; margin:8px 0;"><br>
          <label><b>Price (‚Çπ):</b></label><br>
          <input type="number" id="item-price" required style="width:100%; padding:8px; margin:8px 0;"><br>
          <label><b>Description:</b></label><br>
          <input type="text" id="item-desc" style="width:100%; padding:8px; margin:8px 0;"><br>
          <label><b>Upload Item Photo:</b></label><br>
          <input type="file" id="item-photo" accept="image/*" required style="margin:8px 0;"><br><br>
          <button type="submit" style="background:#1e40af; color:#fff; padding:8px 16px; border:none; border-radius:6px;">Add Item</button>
        </form>`;
    }
    
    async function addMenuItem(event, category) {
      event.preventDefault();
      
      const photoFile = document.getElementById('item-photo').files[0];
      
      try {
        let imagePath = 'images/default-food.jpg';
        
        if (photoFile) {
          const formData = new FormData();
          formData.append('image', photoFile);
          
          const uploadResponse = await fetch('/api/upload/image', {
            method: 'POST',
            body: formData
          });
          
          if (uploadResponse.ok) {
            const uploadData = await uploadResponse.json();
            imagePath = uploadData.path;
          }
        }
        
        const itemData = {
          name: document.getElementById('item-name').value,
          category: category,
          price: parseInt(document.getElementById('item-price').value),
          description: document.getElementById('item-desc').value,
          image: imagePath
        };
        
        await API.addMenuItem(itemData);
        alert('Item added successfully!');
        document.getElementById('addFormContainer').innerHTML = '';
      } catch (error) {
        alert('Failed to add item: ' + error.message);
      }
    }

    async function loadEditFoodItems() {
      const content = document.getElementById("content");
      content.style.display = "block";
      
      try {
        const categories = ['snacks', 'veg', 'icecream', 'juice', 'nonveg', 'starters'];
        const categoryNames = ['Snacks', 'Veg', 'Ice Creams', 'Juice', 'Non Veg', 'Starters'];
        const categoryImages = ['images/index/snacks.png', 'images/index/veg.jpg', 'images/index/ice.webp', 'images/index/juice.jpg', 'images/index/nonveg.jpg', 'images/index/starters.jpeg'];
        
        const categoryCards = await Promise.all(categories.map(async (category, index) => {
          try {
            const items = await API.getMenuItems(category);
            const itemNames = items.map(item => item.name).join(', ');
            return `
              <div class="food-card" onclick="showEditForm('${category}')">
                <img src="${categoryImages[index]}">
                <div style="font-size:0.75rem; color:#666; margin:5px 0; text-align:center; max-height:40px; overflow-y:auto; line-height:1.2;">
                  ${itemNames || 'No items'}
                </div>
                <span>${categoryNames[index]} (${items.length})</span>
              </div>`;
          } catch (error) {
            return `
              <div class="food-card" onclick="showEditForm('${category}')">
                <img src="${categoryImages[index]}">
                <div style="font-size:0.75rem; color:#666; margin:5px 0; text-align:center;">No items</div>
                <span>${categoryNames[index]} (0)</span>
              </div>`;
          }
        }));
        
        content.innerHTML = `
          <h2 style="color:#1e40af;">Edit Food Items</h2>
          <div class="food-list">
            ${categoryCards.join('')}
          </div>
          <div id="editFormContainer" style="margin-top:30px;"></div>
        `;
      } catch (error) {
        content.innerHTML = '<h2>Failed to load categories</h2>';
      }
    }

    // Show Edit Item Form
    async function showEditForm(category) {
      const formContainer = document.getElementById("editFormContainer");
      
      try {
        const menuItems = await API.getMenuItems(category);
        formContainer.innerHTML = `
          <h3 style="color:#1e40af;">Edit ${category} Item</h3>
          <select id="item-to-edit" onchange="loadItemDetails()" style="width:100%; padding:8px; margin:8px 0;">
            <option value="">-- Select Item to Edit --</option>
            ${menuItems.map(item => `<option value="${item._id}" data-item='${JSON.stringify(item)}'>${item.name} - ‚Çπ${item.price}</option>`).join('')}
          </select>
          <div id="editForm" style="display:none; margin-top:20px;"></div>
        `;
      } catch (error) {
        formContainer.innerHTML = '<p>Failed to load menu items</p>';
      }
    }
    
    function loadItemDetails() {
      const select = document.getElementById('item-to-edit');
      const editForm = document.getElementById('editForm');
      
      if (!select.value) {
        editForm.style.display = 'none';
        return;
      }
      
      const item = JSON.parse(select.selectedOptions[0].dataset.item);
      editForm.style.display = 'block';
      editForm.innerHTML = `
        <form onsubmit="updateMenuItem(event, '${item._id}')" style="text-align:left;">
          <label><b>Food Name:</b></label><br>
          <input type="text" id="edit-name" value="${item.name}" required style="width:100%; padding:8px; margin:8px 0;"><br>
          <label><b>Price (‚Çπ):</b></label><br>
          <input type="number" id="edit-price" value="${item.price}" required style="width:100%; padding:8px; margin:8px 0;"><br>
          <label><b>Description:</b></label><br>
          <input type="text" id="edit-desc" value="${item.description || ''}" style="width:100%; padding:8px; margin:8px 0;"><br>
          <label><b>Available:</b></label><br>
          <select id="edit-available" style="width:100%; padding:8px; margin:8px 0;">
            <option value="true" ${item.available ? 'selected' : ''}>Available</option>
            <option value="false" ${!item.available ? 'selected' : ''}>Not Available</option>
          </select><br>
          <label><b>Stock Quantity:</b></label><br>
          <input type="number" id="edit-stock" value="${item.stock || 50}" min="0" style="width:100%; padding:8px; margin:8px 0;"><br>
          <label><b>Change Image (optional):</b></label><br>
          <input type="file" id="edit-photo" accept="image/*" style="margin:8px 0;"><br>
          <img src="${item.image}" style="width:100px; height:100px; object-fit:cover; margin:8px 0;"><br>
          <button type="submit" style="background:#1e40af; color:#fff; padding:8px 16px; border:none; border-radius:6px; margin-right:10px;">Update Item</button>
          <button type="button" onclick="deleteItem('${item._id}')" style="background:#dc2626; color:#fff; padding:8px 16px; border:none; border-radius:6px;">Delete Item</button>
        </form>
      `;
    }
    
    async function updateMenuItem(event, itemId) {
      event.preventDefault();
      
      try {
        let imagePath = null;
        const photoFile = document.getElementById('edit-photo').files[0];
        
        if (photoFile) {
          const formData = new FormData();
          formData.append('image', photoFile);
          
          const uploadResponse = await fetch('/api/upload/image', {
            method: 'POST',
            body: formData
          });
          
          if (uploadResponse.ok) {
            const uploadData = await uploadResponse.json();
            imagePath = uploadData.path;
          }
        }
        
        const updateData = {
          name: document.getElementById('edit-name').value,
          price: parseInt(document.getElementById('edit-price').value),
          description: document.getElementById('edit-desc').value,
          available: document.getElementById('edit-available').value === 'true',
          stock: parseInt(document.getElementById('edit-stock').value)
        };
        
        if (imagePath) {
          updateData.image = imagePath;
        }
        
        await fetch(`/api/menu/${itemId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API.getToken()}`
          },
          body: JSON.stringify(updateData)
        });
        
        alert('Item updated successfully!');
        document.getElementById('editFormContainer').innerHTML = '';
      } catch (error) {
        alert('Failed to update item: ' + error.message);
      }
    }
    
    async function deleteItem(itemId) {
      if (confirm('Are you sure you want to delete this item?')) {
        try {
          await API.deleteMenuItem(itemId);
          alert('Item deleted successfully!');
          document.getElementById('editFormContainer').innerHTML = '';
        } catch (error) {
          alert('Failed to delete item: ' + error.message);
        }
      }
    }

    function showProfile() {
      const content = document.getElementById("content");
      content.style.display = "block";
      
      const canteen = JSON.parse(localStorage.getItem('canteen') || '{}');
      const photoSrc = canteen.canteenPhoto ? canteen.canteenPhoto : 'images/index/profile.jpg';
      
      content.innerHTML = `
        <h2 style="color:#1e40af; margin-bottom:20px;">Canteen Profile</h2>
        <div style="display:flex; flex-direction:column; align-items:center; gap:20px; padding:20px; background:#f9fafb; border-radius:15px; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
          <img src="${photoSrc}" alt="Canteen Image" id="profileImage"
            style="width:300px; height:200px; border-radius:16px; object-fit:cover; box-shadow:0 4px 10px rgba(0,0,0,0.2);">
          <div id="profileView" style="text-align:left; width:100%; max-width:500px; font-size:1.1rem; line-height:1.8;">
            <p><b style="color:#1e40af;">Canteen Name:</b> ${canteen.name || 'N/A'}</p>
            <p><b style="color:#1e40af;">Email:</b> ${canteen.email || 'N/A'}</p>
            <p><b style="color:#1e40af;">Phone:</b> ${canteen.phone || 'N/A'}</p>
            <p><b style="color:#1e40af;">Canteen ID:</b> ${canteen.canteenId || 'N/A'}</p>
            <p><b style="color:#1e40af;">Address:</b> ${canteen.address || 'N/A'}</p>
            <button onclick="showEditProfile()" style="background:#1e40af; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; margin-top:15px;">Edit Profile</button>
          </div>
          <div id="profileEdit" style="display:none; width:100%; max-width:500px;">
            <form onsubmit="updateProfile(event)" style="text-align:left;">
              <label><b>Canteen Name:</b></label><br>
              <input type="text" id="editName" value="${canteen.name || ''}" required style="width:100%; padding:8px; margin:8px 0; border:1px solid #ddd; border-radius:4px;"><br>
              <label><b>Email:</b></label><br>
              <input type="email" id="editEmail" value="${canteen.email || ''}" required style="width:100%; padding:8px; margin:8px 0; border:1px solid #ddd; border-radius:4px;"><br>
              <label><b>Phone:</b></label><br>
              <input type="text" id="editPhone" value="${canteen.phone || ''}" style="width:100%; padding:8px; margin:8px 0; border:1px solid #ddd; border-radius:4px;"><br>
              <label><b>Address:</b></label><br>
              <input type="text" id="editAddress" value="${canteen.address || ''}" style="width:100%; padding:8px; margin:8px 0; border:1px solid #ddd; border-radius:4px;"><br>
              <label><b>Change Photo:</b></label><br>
              <input type="file" id="editPhoto" accept="image/*" style="margin:8px 0;"><br>
              <button type="submit" style="background:#22c55e; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; margin-right:10px;">Save Changes</button>
              <button type="button" onclick="cancelEdit()" style="background:#6b7280; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">Cancel</button>
            </form>
          </div>
        </div>
      `;
    }

    function showEditProfile() {
      document.getElementById('profileView').style.display = 'none';
      document.getElementById('profileEdit').style.display = 'block';
    }

    function cancelEdit() {
      document.getElementById('profileView').style.display = 'block';
      document.getElementById('profileEdit').style.display = 'none';
    }

    async function updateProfile(event) {
      event.preventDefault();
      
      try {
        const updateData = {
          name: document.getElementById('editName').value,
          email: document.getElementById('editEmail').value,
          phone: document.getElementById('editPhone').value,
          address: document.getElementById('editAddress').value
        };
        
        const photoFile = document.getElementById('editPhoto').files[0];
        if (photoFile) {
          const formData = new FormData();
          formData.append('image', photoFile);
          
          const uploadResponse = await fetch('/api/upload/image', {
            method: 'POST',
            body: formData
          });
          
          if (uploadResponse.ok) {
            const uploadData = await uploadResponse.json();
            updateData.canteenPhoto = uploadData.path;
          }
        }
        
        // Update canteen profile via API
        let updatedCanteen;
        try {
          const response = await fetch('/api/admin/profile', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('adminToken') || API.getToken()}`
            },
            body: JSON.stringify(updateData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to update profile');
          }
          
          updatedCanteen = await response.json();
        } catch (apiError) {
          console.error('API Error:', apiError);
          // Fallback to localStorage update
          const currentCanteen = JSON.parse(localStorage.getItem('canteen') || '{}');
          updatedCanteen = { ...currentCanteen, ...updateData };
        }
        
        localStorage.setItem('canteen', JSON.stringify(updatedCanteen));
        
        // Update navbar display
        const nameDisplay = document.getElementById('canteen-name-display');
        if (nameDisplay) {
          nameDisplay.textContent = updatedCanteen.name || 'Canteen';
        }
        
        // Update navbar profile image
        const profileNavImg = document.querySelector('.nav-item:nth-child(4) img');
        if (profileNavImg && updatedCanteen.canteenPhoto) {
          profileNavImg.src = updatedCanteen.canteenPhoto;
        }
        
        alert('Profile updated successfully!');
        showProfile();
      } catch (error) {
        alert('Failed to update profile: ' + error.message);
      }
    }
    
    function logout() {
      localStorage.removeItem('canteenLoggedIn');
      localStorage.removeItem('canteen');
      API.removeToken();
      
      alert('You are logged out');
      window.location.href = 'index.html';
    }

    window.showEditProfile = showEditProfile;
    window.cancelEdit = cancelEdit;
    window.updateProfile = updateProfile;
  </script>
</body>
</html>