<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Order Tracking - MITS Canteen</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 400px; width: 100%; border-radius: 10px; }
        .tracking-container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .order-info { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status-badge { padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold; }
        .status-preparing { background: #ff9800; }
        .status-ready { background: #2196f3; }
        .status-out-for-delivery { background: #9c27b0; }
        .status-delivered { background: #4caf50; }
        .delivery-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .info-card { background: #f5f5f5; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="tracking-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>Live Order Tracking</h1>
            <button onclick="window.location.href='my-orders.html'" class="button">‚Üê Back to Orders</button>
        </div>

        <div class="order-info">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 id="order-id">Order #12345</h3>
                    <p id="order-items">Loading...</p>
                </div>
                <span id="order-status" class="status-badge">Preparing</span>
            </div>
            
            <div class="delivery-info">
                <div class="info-card">
                    <h4>üìç Delivery Location</h4>
                    <p id="delivery-address">Loading...</p>
                    <p id="estimated-time">ETA: Calculating...</p>
                </div>
                <div class="info-card">
                    <h4>üöö Delivery Person</h4>
                    <p id="delivery-person">Assigned when ready</p>
                    <p id="contact-info">Contact: N/A</p>
                </div>
            </div>
        </div>

        <div id="map"></div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="shareLocation()" class="button" style="background: #4caf50;">üìç Share My Location</button>
            <button onclick="toggleSatellite()" class="button" style="background: #ff9800; margin-left: 10px;" id="satellite-btn">üõ∞Ô∏è Satellite View</button>
            <button onclick="refreshTracking()" class="button" style="background: #2196f3; margin-left: 10px;">üîÑ Refresh</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/api.js"></script>
    <script>
        let map, userMarker, deliveryMarker, routeControl;
        let orderId = new URLSearchParams(window.location.search).get('orderId');
        let satelliteLayer, isSatelliteView = false;
        
        // MITS Campus coordinates
        const mitsCanteen = [13.629686, 78.479767];
        let userLocation = null;

        // Initialize map
        function initMap() {
            map = L.map('map').setView(mitsCanteen, 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add canteen marker
            L.marker(mitsCanteen)
                .addTo(map)
                .bindPopup('üè¢ MITS Canteen')
                .openPopup();
        }

        // Get user's current location
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        
                        if (userMarker) map.removeLayer(userMarker);
                        userMarker = L.marker(userLocation)
                            .addTo(map)
                            .bindPopup('üìç Your Location');
                        
                        // Fit map to show both locations
                        const group = new L.featureGroup([
                            L.marker(mitsCanteen),
                            L.marker(userLocation)
                        ]);
                        map.fitBounds(group.getBounds().pad(0.1));
                        
                        calculateRoute();
                    },
                    (error) => {
                        console.error('Location error:', error);
                        alert('Unable to get your location. Please enable location services.');
                    }
                );
            }
        }

        // Calculate route between canteen and user
        function calculateRoute() {
            if (!userLocation) return;
            
            // Simple route calculation (in real app, use routing service)
            const distance = calculateDistance(mitsCanteen, userLocation);
            const eta = Math.round(distance * 2); // 2 minutes per km
            
            document.getElementById('estimated-time').textContent = `ETA: ${eta} minutes`;
            
            // Draw simple line (in real app, use proper routing)
            if (routeControl) map.removeLayer(routeControl);
            routeControl = L.polyline([mitsCanteen, userLocation], {
                color: '#2196f3',
                weight: 4,
                opacity: 0.7
            }).addTo(map);
        }

        // Calculate distance between two points
        function calculateDistance(point1, point2) {
            const R = 6371; // Earth's radius in km
            const dLat = (point2[0] - point1[0]) * Math.PI / 180;
            const dLon = (point2[1] - point1[1]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(point1[0] * Math.PI / 180) * Math.cos(point2[0] * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Load order details
        async function loadOrderDetails() {
            if (!orderId) {
                document.getElementById('order-id').textContent = 'No order selected';
                return;
            }

            try {
                // In real app, fetch from API
                // const order = await API.getOrder(orderId);
                
                // Mock data for demo
                const order = {
                    id: orderId,
                    items: ['Chicken Biryani x1', 'Mango Juice x1'],
                    status: 'preparing',
                    deliveryAddress: 'MITS Hostel Block A, Room 205',
                    deliveryPerson: null
                };

                document.getElementById('order-id').textContent = `Order #${order.id}`;
                document.getElementById('order-items').textContent = order.items.join(', ');
                document.getElementById('delivery-address').textContent = order.deliveryAddress;
                
                updateOrderStatus(order.status);
                
            } catch (error) {
                console.error('Error loading order:', error);
            }
        }

        // Update order status
        function updateOrderStatus(status) {
            const statusElement = document.getElementById('order-status');
            const deliveryPersonElement = document.getElementById('delivery-person');
            const contactElement = document.getElementById('contact-info');
            
            statusElement.className = `status-badge status-${status}`;
            
            switch (status) {
                case 'preparing':
                    statusElement.textContent = 'Preparing';
                    break;
                case 'ready':
                    statusElement.textContent = 'Ready for Pickup';
                    deliveryPersonElement.textContent = 'Ravi Kumar';
                    contactElement.textContent = 'Contact: +91 98765 43210';
                    break;
                case 'out-for-delivery':
                    statusElement.textContent = 'Out for Delivery';
                    simulateDeliveryMovement();
                    break;
                case 'delivered':
                    statusElement.textContent = 'Delivered';
                    break;
            }
        }

        // Simulate delivery person movement
        function simulateDeliveryMovement() {
            if (!userLocation) return;
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 0.1;
                
                if (progress >= 1) {
                    clearInterval(interval);
                    updateOrderStatus('delivered');
                    return;
                }
                
                // Interpolate position between canteen and user
                const lat = mitsCanteen[0] + (userLocation[0] - mitsCanteen[0]) * progress;
                const lng = mitsCanteen[1] + (userLocation[1] - mitsCanteen[1]) * progress;
                
                if (deliveryMarker) map.removeLayer(deliveryMarker);
                deliveryMarker = L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup('üöö Delivery Person');
                
                // Update ETA
                const remainingDistance = calculateDistance([lat, lng], userLocation);
                const eta = Math.round(remainingDistance * 2);
                document.getElementById('estimated-time').textContent = `ETA: ${eta} minutes`;
                
            }, 2000); // Update every 2 seconds
        }

        // Share location function
        function shareLocation() {
            getUserLocation();
        }

        // Toggle satellite view
        function toggleSatellite() {
            const btn = document.getElementById('satellite-btn');
            
            if (!isSatelliteView) {
                // Switch to satellite view
                satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '¬© Esri, Maxar, Earthstar Geographics'
                });
                
                map.eachLayer(function(layer) {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                satelliteLayer.addTo(map);
                btn.textContent = 'üó∫Ô∏è Street View';
                btn.style.background = '#2196f3';
                isSatelliteView = true;
            } else {
                // Switch back to street view
                map.removeLayer(satelliteLayer);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                btn.textContent = 'üõ∞Ô∏è Satellite View';
                btn.style.background = '#ff9800';
                isSatelliteView = false;
            }
        }

        // Refresh tracking
        function refreshTracking() {
            loadOrderDetails();
            if (userLocation) calculateRoute();
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadOrderDetails();
            getUserLocation();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshTracking, 30000);
        });
    </script>
</body>
</html>